@page "/tournaments/{id}"
@using Unmatched.Services
@using Unmatched.Dtos
@using BlazorBootstrap
@using Unmatched.Enums
@inject ITournamentService TournamentService
@inject IMatchService MatchService

<div class="page-content">
    <h1 class="page-title" style="text-align: center">@TournamentModel.Name</h1>
    <div class="net">
        <div>
            <TournamentStage TournamentModel="TournamentModel" Stage="Stage.EighthFinals" StageMatches="octoFinals" Maps="_maps"></TournamentStage>
        </div>
        <div>
            <TournamentStage TournamentModel="TournamentModel" Stage="Stage.QuarterFinals" StageMatches="quarterFinals" Maps="_maps"></TournamentStage>
        </div>
        <div>
            <TournamentStage TournamentModel="TournamentModel" Stage="Stage.SemiFinals" StageMatches="semiFinalsMatches" Maps="_maps"></TournamentStage>
        </div>
        <div>
            <TournamentStage TournamentModel="TournamentModel" Stage="Stage.ThirdPlaceDecider" StageMatches="thirdPlaceFinalsMatches" Maps="_maps"></TournamentStage>
        </div>
        <div>
            <TournamentStage TournamentModel="TournamentModel" Stage="Stage.GrandFinals" StageMatches="finalsMatches" Maps="_maps"></TournamentStage>
        </div>
    </div>
    @* <button class="btn btn-primary" onclick="@OnFinishTournamentClick">Finish tournament</button> *@
</div>

@code {
    [Parameter]
    public string Id { get; set; } = "";

    private TournamentDto TournamentModel { get; set; } = new ();

    private List<MapDto> _maps = new();
    
    private bool isFinished;

    public List<MatchDto> octoFinals = new(); 
    public List<MatchDto> quarterFinals = new(); 
    public List<MatchDto> semiFinalsMatches = new(); 
    public List<MatchDto> thirdPlaceFinalsMatches = new(); 
    public List<MatchDto> finalsMatches = new();
    
    [Inject] protected PreloadService PreloadService { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            PreloadService.Show();
            Guid.TryParse(Id, out var tournamentId);
            if (tournamentId == Guid.Empty)
            {
                return;
            }
            
            TournamentModel = await TournamentService.GetAsync(tournamentId);
            _maps = (await MatchService.GetAllMapsAsync()).ToList();
            
            octoFinals = (await MatchService.GetByTournamentIdAsync(tournamentId, Stage.EighthFinals)).ToList();
            quarterFinals = (await MatchService.GetByTournamentIdAsync(tournamentId, Stage.QuarterFinals)).ToList();
            semiFinalsMatches = (await MatchService.GetByTournamentIdAsync(tournamentId, Stage.SemiFinals)).ToList();
            thirdPlaceFinalsMatches = (await MatchService.GetByTournamentIdAsync(tournamentId, Stage.ThirdPlaceDecider)).ToList();
            finalsMatches = (await MatchService.GetByTournamentIdAsync(tournamentId, Stage.GrandFinals)).ToList();
            if (finalsMatches.Count > 0)
            {
                isFinished = true;
            }
        }
        finally
        {
            PreloadService.Hide();
        }
    }

    public async Task OnFinishTournamentClick()
    {
        TournamentModel.IsActive = false;
        // await TournamentService.UpdateAsync(TournamentModel);
    }
}

<style>
    .net {
          display: grid;
          grid-template-columns: repeat(5, 1fr);
    }
</style>